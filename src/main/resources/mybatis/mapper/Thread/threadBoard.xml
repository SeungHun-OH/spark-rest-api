<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spark.dating.thread.ThreadDao">

  <resultMap id="BoardReplyResponseMap" type="BoardReplyResponse">
    <id property="brNo" column="BR_NO" />
    <result property="brThreadBoardNo" column="BR_THREADBOARDNO" />
    <result property="brMemberNo" column="BR_MEMBERNO" />
    <result property="brContent" column="BR_CONTENT" />
    <result property="createdAt" column="createdAt" />
  </resultMap>

  <!-- 게시글 + 댓글 컬렉션 매핑 -->
  <resultMap id="ThreadBoardResponseMap" type="ThreadBoardResponse">
    <id property="tbNo" column="TB_NO" />
    <result property="tbTitle" column="TB_TITLE" />
    <result property="tbContent" column="TB_CONTENT" />
    <result property="tbLikeCount" column="TB_LIKECOUNT" />
    <result property="tbMemberNo" column="TB_MEMBERNO" />

    <!-- ✅ select만 남기고 resultMap 제거 -->
    <collection property="boardReplys" column="TB_NO" select="getRepliesByBoardNo" />
  </resultMap>

  <insert id = "insertThreadBoard" parameterType="ThreadBoard">
    <selectKey keyProperty="tbNo" resultType="int" order="BEFORE">
      SELECT THREAD_BOARD_SEQ.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO THREADBOARD
     (TB_NO, 
      TB_TITLE, 
      TB_CONTENT, 
      TB_MEMBERNO, 
      TB_ACTIVE, 
      TB_DATE, 
      CREATEDAT)
    VALUES
     (#{tbNo}, 
      #{tbTitle}, 
      #{tbContent}, 
      #{tbMemberNo}, 
      'Y', 
      SYSDATE, 
      SYSDATE)
  </insert>

  <select id = "getThreadBoard" parameterType= "int" resultType="ThreadBoard">
    SELECT *
    FROM THREADBOARD TB
    WHERE TB.TB_NO = #{tbNo}
  </select>

  <select id="searchThreadBoards" parameterType="string" resultMap="ThreadBoardResponseMap">
    SELECT    
      TB.TB_NO,
      TB.TB_TITLE,
      TB.TB_CONTENT,
      TO_CHAR(TB.TB_DATE, 'YYYY-MM-DD HH24:MI:SS') as tbDate,
      TB.TB_ACTIVE as tbActive,
      TB.TB_LIKECOUNT as tbLikeCount,
      TB.TB_MEMBERNO,
      TB.TB_VIEWCOUNT as tbViewCount,
      TB.TB_IMAGENO as tbImageNo,

      TB.CREATEDAT as createdAt,
      TB.UPDATEDAT as updatedAt,
      
      M.M_ID       as memberId,
      M.M_NAME     as memberName,
      MP.MP_ATTACHDATA as memberPicture

      FROM THREADBOARD TB
      JOIN MEMBER M ON TB.TB_MEMBERNO = M.M_NO
      JOIN MEMBERPICTURE MP ON TB.TB_MEMBERNO = MP.MP_MEMBERNO 
      
      WHERE TB.TB_ACTIVE = 'Y'
      AND (TB.TB_TITLE LIKE '%' || #{keyword} || '%' OR TB.TB_CONTENT LIKE '%' || #{keyword} || '%')
      ORDER BY TB.TB_NO DESC
    </select>


  <select id = "getThreadBoardList" resultMap="ThreadBoardResponseMap">
    SELECT    
      TB.TB_NO,
      TB.TB_TITLE,
      TB.TB_CONTENT,
      TO_CHAR(TB.TB_DATE, 'YYYY-MM-DD HH24:MI:SS') as tbDate,
      TB.TB_ACTIVE as tbActive,
      TB.TB_LIKECOUNT as tbLikeCount,
      TB.TB_MEMBERNO,
      TB.TB_VIEWCOUNT as tbViewCount,
      TB.TB_IMAGENO as tbImageNo,

      TB.CREATEDAT as createdAt,
      TB.UPDATEDAT as updatedAt,
      
      M.M_ID       as memberId,
      M.M_NAME     as memberName,
      MP.MP_ATTACHDATA as memberPicture

      FROM THREADBOARD TB
      JOIN MEMBER M ON TB.TB_MEMBERNO = M.M_NO
      JOIN MEMBERPICTURE MP ON TB.TB_MEMBERNO = MP.MP_MEMBERNO 
      
      WHERE TB.TB_ACTIVE = 'Y'
      ORDER BY TB.TB_NO DESC
  </select>

  <select id="getRepliesByBoardNo" parameterType="int" resultMap="BoardReplyResponseMap">
    SELECT
      BR.BR_NO,
      BR.BR_THREADBOARDNO,
      BR.BR_MEMBERNO,
      BR.BR_CONTENT,

      TO_CHAR(BR.CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') as createdAt,

      M.M_NAME as memberName,
      MP.MP_ATTACHDATA as memberPicture

    FROM BOARDREPLY BR
    JOIN MEMBER M ON BR.BR_MEMBERNO = M.M_NO
    JOIN MEMBERPICTURE MP ON BR.BR_MEMBERNO = MP.MP_MEMBERNO 

    WHERE BR.BR_THREADBOARDNO = #{tbNo}
    ORDER BY BR.BR_NO ASC
  </select>

  <delete id = "deleteThreadBoard" parameterType="int">
    DELETE FROM THREADBOARD
    WHERE TB_NO  = #{tbNo}
  </delete>

  <delete id = "deleteBoardRepliesByBoardNo" parameterType="int">
    DELETE FROM BOARDREPLY
    WHERE BR_THREADBOARDNO = #{tbNo}
  </delete>

  <update id = "updateThreadBoard" parameterType="ThreadBoard">
    update THREADBOARD
    SET 
      TB_TITLE = #{tbTitle},
      TB_CONTENT = #{tbContent},
      TB_DATE = TO_DATE(#{tbDate}, 'YYYY-MM-DD HH24:MI:SS'),
      TB_ACTIVE = #{tbActive},
      TB_LIKECOUNT = #{tbLikeCount},
      TB_MEMBERNO = #{tbMemberNo},
      TB_VIEWCOUNT = #{tbViewCount},
      TB_IMAGENO = #{tbImageNo},
      UPDATEDAT = SYSDATE
       
      where TB_NO = #{tbNo}
  </update>

</mapper>



<!-- <result property="createdAt" column="createdAt" />
  <result property="memberName" column="memberName" />
  <result property="memberPicture" column="memberPicture" /> -->

<!-- <result property="memberName" column="BR_MEMBERNAME" />
    <result property="memberPicture" column="BR_MEMBERPICTURE" /> -->