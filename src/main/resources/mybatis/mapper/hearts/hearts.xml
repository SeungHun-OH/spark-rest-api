<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spark.dating.hearts.HeartsDao">

  <!--구현-->
  <insert id="createMatching" parameterType="com.spark.dating.dto.hearts.HeartsRequest">
    <selectKey keyProperty="matchingNo" order="BEFORE" resultType="Long">
      SELECT SEQ_MATCHING_NO.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO MATCHING (MT_NO, MT_HEARTSNO, MT_DATE)
    VALUES (#{matchingNo}, #{heartsNo}, SYSDATE )
  </insert>

  <insert id="insertHeart" parameterType="map">
    <selectKey keyProperty="No" order="BEFORE" resultType="Long">
      SELECT h_no_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO HEARTS (h_senduser, h_receiveuser, h_date, h_requestchanel)
    VALUES (#{senderNo}, #{partnerNo}, SYSDATE, #{requestChannel})

  </insert>

  <select id="selectByHno" parameterType="int" resultType="Hearts">
    SELECT h_no, h_senduser, h_receiveuser, h_date, h_requestchanel
    FROM hearts
    WHERE h_no = #{hNo}
  </select>

  <select id="selectByChanel" resultType="Hearts">
    SELECT h_no, h_senduser, h_receiveuser, h_date, h_requestchanel
    FROM hearts
    WHERE h_receiveuser = #{m_no}
      AND h_requestchanel = #{h_requestchanel}
  </select>

  <delete id="injectHeartRequest"
          parameterType="Long">
    DELETE FROM hearts
    WHERE h_no = #{heartsNo}
  </delete>
  
  <!--나를 좋아요한 행을 가져오고, 보낸 사람의 프로필 정보와 섬네일을 조인해 리턴-->
  <select id="selectReceivedHeartRequests" parameterType="int" resultType="Hearts">
	SELECT 
	    H.H_NO             AS no,
	    H.H_DATE           AS requestDate,
	    H.H_REQUESTCHANEL  AS reqeustChannel,
	    M.M_NAME           AS name,
	    M.M_AGE            AS age,
	    M.M_REGION         AS region,
	    M.M_UUID           AS uuid,
	    P.MP_NO            AS mpNo
	FROM HEARTS H
	JOIN MEMBER M
	  ON H.H_SENDUSER = M.M_NO
	LEFT JOIN MEMBERPICTURE P
	  ON P.MP_MEMBERNO = M.M_NO
	WHERE H.H_RECEIVEUSER = #{memberNo}
	ORDER BY requestDate DESC
  </select>

</mapper>